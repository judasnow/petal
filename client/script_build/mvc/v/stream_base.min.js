/*! petal_client 2013-07-08 */
define(["underscore","backbone","mustache"],function(a,b){"use strict";var c=b.View.extend({baseInitialize:function(b,c,d,e,f,g){$.ui.addOrUpdateDiv(b,c),$.ui.loadContent(g,!1,!1,"none"),this.$el=$("#"+b),this.$el.unbind(),this.q=f,this.coll=e,this.ItemView=d,this.firstFetch=!0,a.bindAll(this,"addOne","addAll","fetchOk","fetchFail","fetchMore"),this.$items=this.$el.find(".items");var h=this.$el.scroller();h.refresh=!1,this.scroll=h,this.p=1,this.coll.bind("add",this.addOne),this.coll.bind("reset",this.addAll),this.fetchMore(),this.$fetchMore=this.$el.find(".fetch_more"),this.listenTo(this.$fetchMore,"tap",this.fetchMore)},addAll:function(){this.coll.each(this.addOne)},addOne:function(a){var b=new this.ItemView({model:a});this.$items.append(b.render().el)},fetchOk:function(a){a.length>0?(this.isFetching=!1,this.firstFetch=!1):this.firstFetch===!0?(window.updateSysNotice("没有相应的记录"),this.$items.text("没有相应的记录"),this.$fetchMore.hide()):(window.updateSysNotice("没有更多了"),this.stopListening(this.$fetchMore,"tap",this.fetchMore),this.$fetchMore.addClass("disable").text("没有更多了"))},fetchFail:function(){window.updateSysNotice("加载失败了,稍候再试一次吧。")},fetchMore:function(){return this.isFetching===!0?!1:(this.isFetching=!0,this.coll.fetch({data:{p:this.p,q:"undefined"==typeof this.q||""===this.q?{}:this.q},success:this.fetchOk,error:this.fatchFail}),this.p=this.p+1,void 0)}});return c});