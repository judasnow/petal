/*! petal_client 2013-07-08 */
define(["underscore","backbone","mustache","m/chat_item","c/chat_items","v/chat_item","v/sys_notice","text!tpl/chat_list.html","lib/common_operate"],function(a,b,c,d,e,f,g,h,i){"use strict";var j=b.View.extend({template:h,initialize:function(){a.bindAll(this,"sendMsg","addOne","addAll","render"),this.$el=$.ui.addOrUpdateDiv("chat_list",this.template,!0),$.ui.loadContent("#chat_list",!1,!1,"none"),this.$items=this.$el.find(".items"),this.$inputAreaBox=$("#input_area_box"),this.$sendBtn=this.$inputAreaBox.find(".submit"),this.$chatInput=this.$inputAreaBox.find(".chat_input"),this.$sendBtn.on("click",this.sendMsg),this.chatItems=new e,this.chatItems.bind("change",this.render),this.chatItems.bind("add",this.addOne),this.chatItems.bind("reset",this.addAll),this.$el.on("new_msg",$.proxy(function(a){this.addOne(new d(a.data))},this)),this.chatItems.fetch({data:{user_id:window.objectUser.get("UserId"),root_msg_id:window.localStorage.getItem("petal:root_msg_id")}})},addOne:function(a){var b=new f({model:a});this.$items.append(b.render().el)},addAll:function(){this.chatItems.each(this.addOne)},render:function(){return this},sendMsg:function(){var a=this.$chatInput.val();if(""!==a){var b=window.localStorage.getItem("petal:send_msg_target_user_id"),c=window.localStorage.getItem("petal:root_msg_id");$.post("/api/send_msg",{target_user_id:b,object_user_id:window.objectUser.get("UserId"),content:a,root_msg_id:c},$.proxy(function(b){var c=JSON.parse(b);"ok"===c.result?(this.$chatInput.val(""),"True"===c.need_pay&&window.updateSysNotice("金币 -"+window.costOfSendMsg),this.addOne(new d({SrcUserId:window.objectUser.get("UserId"),SrcHeadPic:window.objectUser.get("HeadPic"),sex_in_english:window.objectUser.get("sexInEnglish"),Content:a}))):i.insufficientCoinHandle()},this),function(a){console.dir(a)})}else window.updateSysNotice("信息内容不能为空")}});return j});