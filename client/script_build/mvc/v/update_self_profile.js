/*! petal_client 2013-07-08 */
define(["underscore","backbone","mustache","m/user","m/user_profile_base_info","v/menu","text!tpl/update_self_profile.html","text!tpl/div/location_select.html","text!tpl/div/looks_select.html","lib/helper"],function(a,b,c,d,e,f,g,h,i,j){"use strict";var k=b.View.extend({template:g,events:{"tap .add_picture":"openFileSelectDialog","tap .user_picture_box":"tapPicture","tap .looks .label":"tapLabel","tap .do_update":"doUpdate","change .user_upload_picture_input":"fileNameChanged","change .province":"provinceChange","change .zwms":"setUserHasChangedInfo","change .birthday":"setUserHasChangedInfo"},initialize:function(){this.$el=$.ui.addOrUpdateDiv("update_self_profile",""),a.bindAll(this,"render","openFileSelectDialog","fileNameChanged","provinceChange","doUpdate","checkChangeAndGoBack","tapLabel"),this.files=[],this.userPictureBoxTpl=$("#user_picture_box_tpl").html(),this.model=new d,this.listenTo(this.model,"change",this.render),this.model.fetch({data:{user_id:window.objectUser.get("UserId")},error:function(){console.dir("on #user_self_profile fetch user_info error")}})},tapLabel:function(a){var b=$(a.target),c=b.find("input");b.hasClass("label_active")?b.removeClass("label_active"):b.addClass("label_active"),"true"===c.attr("checked")?c.removeAttr("checked"):c.attr("checked","true"),this.userhasChangedInfo=!0},setUserHasChangedInfo:function(){this.userhasChangedInfo=!0},checkChangeAndGoBack:function(){this.userhasChangedInfo===!0?$.ui.popup({title:"",message:"离开本页将丢失修改，是否确认离开？",doneCallback:function(){$.ui.goBackWithDefault()}}):$.ui.goBackWithDefault()},provinceChange:function(){this.userhasChangedInfo=!0,$.proxy(e.provinceChange,this)()},openFileSelectDialog:function(){this.$fileInput.trigger("click")},fileNameChanged:function(){this.userhasChangedInfo=!0,"undefined"==typeof this.$userUploadFile&&(this.$userUploadFile=this.$el.find(".user_upload_picture_input")),"undefined"==typeof this.$album&&(this.$album=this.$el.find(".user_album"));var a=this,b=this.$userUploadFile[0].files,d=this.$album;if(b.length>0){var e=b[0];if(e.size>2048e3)return alert("上传的图片太大了,图片大小不能超过 2M"),void 0;var f=new FileReader;f.onload=function(b){d.prepend(c.to_html(a.userPictureBoxTpl,{uid:(new Date).getTime(),image:b.target.result}))},this.files.push(b[0]),f.readAsDataURL(b[0])}},doUpdate:function(){var b=a.reduce(this.$looks.find("input:checked"),function(a,b){return a+" "+$(b).val()},""),c=window.objectUser.get("UserId");if("undefined"!=typeof this.files)for(var f=0;f<this.files.length;f++){var g=new XMLHttpRequest,h=new FormData;h.append("user_upload_picture",this.files[f]),h.append("user_id",c),g.open("POST","/api/upload_files"),g.send(h)}this.userhasChangedInfo===!0?$.post("/api/user/",{user_id:c,area_id:e.getAreaIdFromCityName(this.$cityname.val()),zwms:this.$zwms.val(),looks:b},function(a){var b=JSON.parse(a);if("ok"===b.result){window.updateSysNotice("保存成功");var e=new d;e.fetch({data:{user_id:c},success:function(a){window.objectUser=a,window.localStorage.setItem("petal:object_user_info",JSON.stringify(a.toJSON())),window.router.navigate("/#stream",{trigger:!0})},error:function(){console.log("save ok, fetch user info error")}})}else alert("保存失败,请稍后再试一次")},function(){alert("保存失败,请稍后再试一次")}):(alert("保存成功"),window.router.navigate("/#stream",{trigger:!0}))},render:function(){$.ui.updateContentDiv("update_self_profile",c.to_html(this.template,this.model.toJSON(),{location_select:c.to_html(h,e),looks_select:c.to_html(i,e[this.model.get("isFemale")?"looks_famale":"looks_male"])})),$.ui.loadContent("#update_self_profile",!1,!1,"none"),$($("#header .button")[0]).bind("tap",this.checkChangeAndGoBack),this.$province=this.$el.find(".province"),this.$cityname=this.$el.find(".cityname"),this.$userId=this.$el.find(".user_id"),this.$zwms=this.$el.find(".zwms"),this.$looks=this.$el.find(".looks"),this.$fileInput=this.$el.find(".user_upload_picture_input"),j.showImage(this.$el.find("img"));var b=this.model.get("location").split(" "),d=b[0],f=b[1];""!=d&&(this.$province.val(d).trigger("change"),this.$cityname.val(f));var g=this.model.get("WM").split(" "),k=this.$looks;return a.each(g,function(a){""!==a&&k.find("input[value="+a+"]").parent().trigger("tap")}),this.userhasChangedInfo=!1,this}});return k});