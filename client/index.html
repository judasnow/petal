<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-type" content="text/html; charset=utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes" >

        <link rel="stylesheet" type="text/css" href="/script/lib/jqmobi/kitchensink/icons.css" />
        <link rel="stylesheet" type="text/css" href="/script/lib/jqmobi/kitchensink/jq.ui_3.css" />

        <link rel="stylesheet/less" type="text/css" href="/style/less/main.less">
        <script src="/script/lib/less-1.3.3.min.js"></script>

        <script src="/script/lib/socket.io.js"></script>
        <script src="/script/lib/jqmobi/ui/jq.ui.min.js"></script>
        <script src="/script/lib/jqmobi/plugins/jq.scroller.js"></script>
        <script>
            //jqmobi init
            //{{{
            $.ui.isAjaxApp=true;
            $.ui.openLinksNewTab = false;
            $.ui.resetScrollers = false;
            $.ui.nativeTouchScroll = false;
            $.ui.autoLaunch = false;
            $.ui.showBackbutton=false;
            $.ui.customClickHandler=function(){ return true;}
            //}}}

            //加载 main.js 
            //{{{
            $.ui.ready( function() {
                var oHead = document.getElementsByTagName( "HEAD" ).item( 0 ); 
                var oScript= document.createElement( "script" ); 
                oScript.setAttribute( "data-main" , "/script/main.js" )
                oScript.src = "/script/lib/require.js";
                oHead.appendChild( oScript );
            });//}}}

            //jqmobi 初始化完成之后的操作
            var onDeviceReady = function() {
            //{{{
                AppMobi.device.setRotateOrientation( "portrait" );
                AppMobi.device.setAutoRotate( false );
                webRoot = AppMobi.webRoot + "/";
                AppMobi.device.hideSplashScreen();
                $.ui.blockPageScroll();
            };//}}}
            document.addEventListener( "appMobi.device.ready" , onDeviceReady , false );

            var init = function() {
            //{{{
                //初始化  socketio 
                //此处对于 js 的异步事件模型有一个疑问 connection 事件我是在 connent 调用之后进行的绑定
                //connection 事件如何会成功的执行呢？也就是说 绑定事件的时候其可能已经触发了该事件
                //window.socketServer = "http://icket.us:8800";
                //window.socketServer = "http://io.icket.us:8800";
                window.socketServer = "http://172.17.0.47:8800";
                window.socket = io.connect( window.socketServer );

                socket.on( "error" , function() {
                    console.log( "socket connect fail" );
                });

                socket.on( "disconnect" , function() {
                    console.log( "socket disconnected" );
                });

                socket.on( "connect" , function() {
                    console.log( "socket connected" );

                    //判断当前用户是否已经登录系统
                    //{{{
                    var objectUserInfo = window.localStorage.getItem( "petal:object_user_info" );
                    if( objectUserInfo === null ) {
                        //还没有登录系统 将显示登录界面
                        console.log( "未登录" )

                        //隐藏 splashscreen 显示登录界面
                        var $splashscreenEl = $( "#splashscreen" ).hide();
                        var $loginEl = $( "#login" ).show();
                        var $usernameEl = $loginEl.find( ".username" );
                        var $passwordEl = $loginEl.find( ".password" );
                        var logging = false;
                        $loginEl.find( ".do_login" ).click( function() {
                            if( logging === true ) {
                                return false;
                            }
                            logging = true;
                            $.post( 
                                "http://172.17.0.46/api/do_login" ,
                                {
                                    username: $usernameEl.val() ,
                                    password: $passwordEl.val()
                                } ,
                                function( res ) {
                                    if( res[0] === "ok" ) {
                                        //登录成功
                                        window.localStorage.setItem( "petal:object_user_info" , res[1] );
                                        $.ui.launch();
                                        //还需要跳转到 #stream
                                        //$loginEl.hide();
                                    } else {
                                        logging = false;
                                        alert( "登录失败" );
                                    }
                                } ,
                                "json"
                             );
                        });
                        return false;
                    } else {
                        window.objectUserInfo = objectUserInfo;
                        $.ui.launch()
                    }//}}}
                });
            }
            //}}}
            document.addEventListener( "DOMContentLoaded" , init , false );
        </script>
    </head>

    <body>
        <div id="jQUi">
            <div id="splashscreen" class='ui-loader'>
                <b>花瓣网</b>
                <br><br>
                <br><br>
                <span class='ui-icon ui-icon-loading spin'></span>
                <h1>应用加载中</h1>
            </div>
            <div id="login">
                <p>
                    <h1 class="title">花瓣网</h1>
                </p>
                <p>
                    <input type="text" name="username" class="username" placeholder="用户名"/>
                </p>
                <p>
                    <input type="password" name="password" class="password" placeholder="密码"/>
                </p>
                <p>
                    <button class="do_login">登录</button>
                    </p>
                </div>
                <nav>
                </nav>
        </div>
    </body>
</html>

