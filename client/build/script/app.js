define(["backbone","router","mustache","underscore","m/user"],function(a,b,c,d,e){"use strict";var f=function(){window.costOfContact=2,window.costOfSendMsg=1,window.objectUser=new e(JSON.parse(window.localStorage.getItem("petal:object_user_info"))),window.updateMenuNotice=function(a){d.each(["msgs","gifts","visitors"],function(b){if("undefined"!=typeof a&&b!==a)return!1;var c=window.localStorage.getItem("petal:new_"+b+"_count");null!==c&&"null"!=c&&"0"!==c?$.ui.updateBadge("#menu ."+b,c):$.ui.removeBadge("#menu ."+b)})};var c=15e3,f=function(a){return a.getFullYear()+"-"+(parseInt(a.getMonth())+1)+"-"+a.getDate()+" "+a.getHours()+":"+a.getMinutes()+":"+a.getSeconds()+":"+a.getMilliseconds()},g=function(a,b){var e="petal:"+a+"_last_update_time",g="petal:new_"+a+"_count",h={};window[e]=window.localStorage.getItem(e)||f(new Date),setInterval(function(){$.get(b+window[e],function(b){var c=JSON.parse(b);if(c=d.filter(c,function(a){return"undefined"==typeof d.find(h,function(b){return d.isEqual(b,a)})}),!d.isEmpty(c)){h=c;var i=c.length;if(i>0){window[e]=f(new Date),window.localStorage.setItem(e,window[e]);var j=window.localStorage.getItem(g);(null===j||isNaN(j))&&(j=0,window.localStorage.setItem(g,0)),"msgs"===a&&d.each(c,function(a){"#chat_list"===window.location.hash&&parseInt(window.localStorage.getItem("petal:root_msg_id"))===a.MBId&&($("#chat_list").trigger("new_msg",a),i-=1)});var k=i;k=parseInt(k)+parseInt(j),window.localStorage.setItem(g,k),window.updateMenuNotice(a)}}})},c)};d.each(["gifts","msgs","visitors"],function(a){g(a,"/api/new_"+a+"/?user_id="+window.objectUser.get("UserId")+"&&last_update_time=")});var h=new b;window.router=h,a.history.start({pushState:!0,hashChange:!0}),console.log("after router"),$.ui.hideMask()};return{initialize:f}});