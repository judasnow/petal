!function(){$.ui.isAjaxApp=!1,$.ui.openLinksNewTab=!1,$.ui.resetScrollers=!1,$.ui.nativeTouchScroll=!1,$.ui.autoLaunch=!1,$.ui.showBackbutton=!1,$.ui.customClickHandler=function(){return!0};var a=function(){var a=document.getElementsByTagName("HEAD").item(0),b=document.createElement("script");b.setAttribute("data-main","/build/script/rquirejs_main_build.js"),b.src="/build/script/lib/require.js",a.appendChild(b),$.ui.showMask()},b=function(){window.localStorage.setItem("petal:object_user_info",""),window.localStorage.setItem("petal:is_new_login","true"),window.localStorage.setItem("petal:root_msg_id","0"),window.localStorage.setItem("petal:send_msg_target_user_id",""),window.localStorage.setItem("petal:info_percent_fullfill",0)};window.updateSysNotice=function(a){window.$sysNotice=window.$sysNotice||$("#system_notice_box"),window.$sysNotice.text(a).attr("style","margin-left: -"+window.$sysNotice.width()/2+"px;z-index: 9999"),setTimeout(function(){window.$sysNotice.attr("style","z-index: -9999")},2e3)},$.ui.addOrUpdateDiv=function(a,b,c){0===$("#"+a).length?$.ui.addContentDiv(a,b,!0,!0):$.ui.updateContentDiv(a,b);var d=$("#"+a);return("undefined"==typeof c||c===!1)&&d.attr("data-footer","none"),d.unbind()},$.ui.goBackWithDefault=function(){1===$.ui.history.length?window.router.navigate("stream",{trigger:!0}):$.ui.goBack()},$.ui.ready(function(){console.log("ui ready"),a()});var c=function(a,c,d){$.post("/api/do_login",{username:a,password:c},function(a){try{var c=JSON.parse(a);if("ok"===c.result){var e=JSON.stringify(c.user_info);if("undefined"==typeof e)throw new Error("json stringify user_info error");b(),window.location.hash="",window.localStorage.setItem("petal:object_user_info",e),window.localStorage.setItem("petal:is_new_login","true"),$.ui.launch()}else logging=!1,d()}catch(f){console.log("登录时发生异常"),logging=!1,d()}})},d=function(){var a=window.location.hash.replace(/^\#/,"").replace(/^\!/,"");c(a,"huaban123",function(){window.location.hash="",$("#login").show()})},e=function(){console.log("appMobi.device.ready fire"),AppMobi.device.setRotateOrientation("portrait"),AppMobi.device.setAutoRotate(!1),webRoot=AppMobi.webRoot+"/",AppMobi.device.hideSplashScreen(),$.ui.blockPageScroll()},f=function(a){if("undefined"!=typeof a&&null!==a){var b=$("#email_address_list").html();$(b).insertAfter(a);var c=a.parent().find(".email_address_list"),d=$("#email_address_list_item").html();c.on("click",".item",function(){var b=$(this);a.val(b.text()),c.hide()});var e=["gmail.com","qq.com","163.com","sina.com","126.com","vip.sina.com","139.com","189.com","wo.com.cn"],f=e.length;a.on("input",function(){var b=a.val();if((b.match(/@$/)||b.match(/^(\w)+(\.\w+)*@(\w)+((\.|\w+)+)$/))&&"none"===c.css("display")&&c.show(),"none"!==c.css("display")){c.html("");var g=b.split("@")[1],h=[],i=0;if("undefined"==typeof g||""===g)h=e;else for(var j=0;f>=j;j+=1){var k=e[j],l=new RegExp("^"+g);if(g===e[j])break;l.test(k)&&h.push(e[j])}if(i=h.length,0===i)c.hide();else for(var j=0;i>j;j+=1){var m=$(d),n=a.val().split("@")[0];if("undefined"==typeof n||""===n)throw new Error("获取用户输入邮箱地址有误 断言 @ 之前不能为空");m.html(n+"@"+h[j]),c.append(m)}}})}},g=function(){$("#splashscreen").hide();var a=window.localStorage.getItem("petal:object_user_info");if(null===a||""===a){var b=window.location,e=$("#login"),g=$("#reg"),h=function(){var a=b.hash;if(a.match(/^#login.*/))if("#login"===a)e.show(),g.hide();else{var f=a.split("/"),h=f[1],i=f[2];c(h,i,function(){window.updateSysNotice("用户名或密码错误")})}else if(a.match(/^#reg.*/)){if("#reg"!==a){var f=a.split("/"),j=f[1],k=f[2];g.find(".user_id").val(j),g.find(".nickname").val(decodeURIComponent(k))}e.hide(),g.show()}else d()};f(e.find(".email")),f(g.find(".email")),e.on("click",".go_to_reg",function(){window.location.hash="reg"}),g.on("click",".go_to_login",function(){window.location.hash="login"}),e.on("click",".do_login",function(){var a=e.find(".email"),b=e.find(".password");c(a.val(),b.val(),function(){window.updateSysNotice("用户名或密码错误")})}),g.on("click",".do_reg",function(){var a=g.find(".nickname"),b=g.find(".email"),c=g.find(".password"),d=g.find(".user_id"),e=b.val(),f=a.val(),h=c.val();return""===f?(window.updateSysNotice("昵称不能为空"),!1):""===e?(window.updateSysNotice("邮箱地址不能为空"),!1):e.match(/^(\w)+(\.\w+)*@(\w)+((\.\w+)+)$/)?""===h?(window.updateSysNotice("密码不能为空"),!1):($.post("/api/reg/",{user_id:d.val(),nickname:f,username:e,password:h},function(a){var b=JSON.parse(a);if("undefined"!=typeof b.user_id&&""!==b.user_id){var c={UserId:b.user_id,UserName:e,NickName:f};window.localStorage.setItem("petal:object_user_info",JSON.stringify(c)),window.location.href="/"}else{var d="注册失败，请稍后再试一次";switch(b.msg){case"username invalid":d="用户名不可用,请重新输入";break;case"nickname invalid":d="昵称不可用,请重新输入"}window.updateSysNotice(d)}}),void 0):(window.updateSysNotice("请填写格式正确的邮箱地址"),void 0)}),window.onhashchange=h,""===b.hash&&(b.hash="login"),h()}else 1===window.location.hash.indexOf("!")&&(window.location.hash=""),$.ui.launch()};document.addEventListener("appMobi.device.ready",e,!1),document.addEventListener("DOMContentLoaded",g,!1)}();